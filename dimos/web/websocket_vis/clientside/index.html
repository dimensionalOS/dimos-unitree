<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot State Visualization</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            margin-top: 0;
        }
        pre#json {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow: auto;
            font-size: 14px;
            max-height: 300px;
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        button {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #3367d6;
        }
        .axis line, .axis path {
            stroke: #aaa;
        }
        .axis text {
            fill: #666;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Robot State Visualization</h1>
        
        <div class="controls">
            <button id="test-costmap">Generate Test Costmap</button>
            <button id="clear">Clear</button>
        </div>
        
        <!-- Visualization container will be inserted here by init.ts -->
        
        <h2>State Data</h2>
        <pre id="json">Loading...</pre>
    </div>

    <script type="module">
        import { RobotStateVisualizer, CostmapVisualizer } from './vis.ts';
        import { Costmap, Grid, Vector } from './types.ts';
        
        // Create a test costmap when the button is clicked
        document.getElementById('test-costmap').addEventListener('click', () => {
            // Create a simple grid with a gradient pattern
            const size = 50;
            const data = new Float32Array(size * size);
            
            // Fill with test data (gradient pattern)
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    // Create a radial distance from center
                    const centerX = size / 2;
                    const centerY = size / 2;
                    const dx = i - centerX;
                    const dy = j - centerY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    // Normalized by max possible distance (corner to center)
                    const maxDist = Math.sqrt(centerX * centerX + centerY * centerY);
                    const normalizedDist = distance / maxDist;
                    
                    // Create obstacles (high values) and free space (low values)
                    let value;
                    if (normalizedDist < 0.2) {
                        // Center is free space
                        value = 0.1;
                    } else if (normalizedDist > 0.8) {
                        // Edge is free space
                        value = 0.1;
                    } else if (normalizedDist > 0.4 && normalizedDist < 0.6) {
                        // Ring of obstacles
                        value = 0.9;
                    } else {
                        // Gradient between
                        value = 0.3 + 0.6 * (normalizedDist - 0.2) / 0.6;
                    }
                    
                    data[i * size + j] = value;
                }
            }
            
            // Create a grid with the test data
            const grid = new Grid(data, [size, size]);
            
            // Create a costmap with the grid
            const costmap = new Costmap(
                grid,
                new Vector(-5, -5),  // origin
                0.2,                // resolution (meters per cell)
                0                   // origin_theta
            );
            
            // Create a vector to show robot position
            const robotPos = new Vector(0, 0);
            
            // Create a state object with the test data
            const testState = {
                status: "connected",
                connected_clients: 1,
                data: {},
                draw: {
                    "costmap": costmap,
                    "robot_position": robotPos
                }
            };
            
            // Update the JSON display
            const jsonElement = document.getElementById("json");
            if (jsonElement) {
                jsonElement.textContent = JSON.stringify(testState, null, 2);
            }
            
            // Create a visualizer if it doesn't exist
            let visContainer = document.getElementById("visualization");
            if (!visContainer) {
                visContainer = document.createElement("div");
                visContainer.id = "visualization";
                visContainer.style.width = "100%";
                visContainer.style.height = "500px";
                visContainer.style.border = "1px solid #ccc";
                visContainer.style.marginBottom = "20px";
                
                const controlsDiv = document.querySelector('.controls');
                if (controlsDiv) {
                    controlsDiv.after(visContainer);
                } else {
                    document.querySelector('.container').appendChild(visContainer);
                }
            }
            
            // Initialize and render
            const visualizer = new RobotStateVisualizer("#visualization", 
                visContainer.clientWidth || 800, 
                500
            );
            
            visualizer.visualizeState(testState.draw);
        });
        
        // Clear button handler
        document.getElementById('clear').addEventListener('click', () => {
            const jsonElement = document.getElementById("json");
            if (jsonElement) {
                jsonElement.textContent = JSON.stringify({
                    status: "connected",
                    connected_clients: 1,
                    data: {},
                    draw: {}
                }, null, 2);
            }
            
            const visContainer = document.getElementById("visualization");
            if (visContainer) {
                visContainer.innerHTML = '';
            }
        });
    </script>
</body>
</html>